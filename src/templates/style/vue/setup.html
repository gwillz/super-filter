{% js at head %}

window.csrfTokenName = "{{ craft.app.config.general.csrfTokenName|e('js') }}";
    window.csrfTokenValue = "{{ craft.app.request.csrfToken|e('js') }}";
    window.superFilterHandle = "{{ handle }}";
    window.superFilterParams = '{{ craft.app.request.getQueryParams()|json_encode()|raw }}';
    window.superFilterCurrentPage = '{{ craft.app.request.getPageNum() }}';
{% endjs %}

{% do view.registerAssetBundle("pdaleramirez\\superfilter\\web\\assets\\VueAsset") %}

{% js %}

let app = new Vue({
    el: "#search-app",
    delimiters: ['${', '}'],
    data: {
        handle: superFilterHandle,
        items: [],
        links: {
            totalPages: 1
        },
        config: {
            params: {
                sort: null,
                fields: []
            }
        },
        loading: false
    },
    methods: {
        submitFilter() {
            this.config.currentPage = 1;

            this.getFilteredItems();
        },
        clearFilter() {
            let fields = this.config.params.fields;
            for (let key in fields) {
                if (Array.isArray(fields[key])) {
                    this.config.params.fields[key] = [];
                } else {
                    this.config.params.fields[key] = "";
                }
            }
            this.getFilteredItems();
        },
        submitSort() {
            this.getFilteredItems();
        },
        onPaginate(pageNum) {
            this.config.currentPage = pageNum;

            this.getFilteredItems();
        },
        getFilteredItems() {
            let data = {
                handle: this.handle,
                config: this.config
            };

            data[csrfTokenName] = csrfTokenValue;
            this.loading = true;
            axios.post('/super-filter/filter', qs.stringify(data))
                .then((response) => {
                    this.items  = response.data.items;
                    this.links  = response.data.links;
                    this.loading = false;
                });
        },
        getFields() {
            let data = {
                handle: this.handle,
                //params: this.params,
                config: this.config
            };

            data[csrfTokenName] = csrfTokenValue;
            this.loading = true;
            axios.post('/super-filter/fields', qs.stringify(data))
                .then(({data}) => {
                    this.config = data.config;
                    this.items  = data.items;
                    this.links  = data.links;
                    this.loading = false;
                });
        }
    },
    mounted() {
        let parse = JSON.parse(superFilterParams);

        this.config.params = {...this.config.params, ...parse};
        this.config.currentPage = Number(superFilterCurrentPage);

        this.getFields();
    }
});
{% endjs %}
