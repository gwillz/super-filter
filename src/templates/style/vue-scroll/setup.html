{% js at head %}

window.csrfTokenName = "{{ craft.app.config.general.csrfTokenName|e('js') }}";
    window.csrfTokenValue = "{{ craft.app.request.csrfToken|e('js') }}";
    window.superFilterHandle = "{{ handle }}";
    window.superFilterParams = '{{ craft.app.request.getQueryParams()|json_encode()|raw }}';
    window.superFilterCurrentPage = '{{ craft.app.request.getPageNum() }}';
{% endjs %}

{% do view.registerAssetBundle("pdaleramirez\\superfilter\\web\\assets\\VueAsset") %}

{% js %}

let app = new Vue({
    el: "#search-app",
    delimiters: ['${', '}'],
    data: {
        handle: superFilterHandle,
        items: [],
        links: {
            totalPages: 1
        },
        config: {
            params: {
                sort: null,
                fields: []
            }
        },
        loading: false,
        currentPage: 1,
        infiniteId: +new Date()
    },
    methods: {
        submitFilter() {
            this.reload();
        },
        clearFilter() {
            let fields = this.config.params.fields;
            for (let key in fields) {
                if (Array.isArray(fields[key])) {
                    this.config.params.fields[key] = [];
                } else {
                    this.config.params.fields[key] = "";
                }
            }
            this.reload();
        },
        submitSort() {
            this.reload();
        },
        reload() {
            this.currentPage = 1;
            this.config.currentPage = this.currentPage;
            this.items = [];
            this.infiniteId+= 1;
        },
        infiniteHandler($state) {
            this.config.currentPage = this.currentPage;

            this.filterItems($state);
        },
        filterItems($state) {
            let data = {
                handle: this.handle,
                config: this.config
            };

            data[csrfTokenName] = csrfTokenValue;

            axios.post('/super-filter/filter', qs.stringify(data))
                .then(({data}) => {
                    if (data.items.length) {
                        this.currentPage++;
                        this.items.push(...data.items);

                        $state.loaded();
                    } else {
                        $state.complete();
                    }
                });
        }
    },
    mounted() {
        let parse = JSON.parse(superFilterParams);

        this.config.params = {...this.config.params, ...parse};
        this.config.currentPage = Number(superFilterCurrentPage);
        let data = {
            handle: this.handle,
            config: this.config
        };

        data[csrfTokenName] = csrfTokenValue;
        axios.post('/super-filter/fields', qs.stringify(data))
            .then(({data}) => {
                this.config = data.config;
            });
    }
});
{% endjs %}
